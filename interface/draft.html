<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>grid generator</title>
    <script src="./jquery.js"></script>
    <script src="../JavaScript/RhythmicGridGenerator.js"></script>

    <style>
      .options {
        margin: 20px 0;
      }

      .ib,
      #placeholder {
        display: inline-block;
        vertical-align: top;
      }

      #grid {
        border: 1px solid #000;
      }

      .ib {
        margin-right: 35px;
      }

      .ib input:disabled + span {
        color: #D26969
      }

      .row {
        background: #e6e6e6;
        white-space: nowrap;
        float:left;
      }

      .block {
        border: 2px solid gray;
        box-sizing: border-box;
        float: left;
      }

    </style>
  </head>
  <body>
    <div class="options">
      <div id="placeholder"></div>
    </div>

    <div id="grid"></div>


    <script type="text/javascript">
      var rgg = RhythmicGridGenerator;
      var srt = function(a,b){ return parseInt(a) > parseInt(b) ? 1 : -1; };

      var width_arr    = [600, 960, 1280, 1440];
      var ratio_arr    = ['16x9', '3x2', '1x1'];
      var baseline_arr = [3,4,5,6,7,8,9,10,11,12];
      var columns_arr  = [5, 6, 9, 12];
      var gutter2baselineRatio_arr = [0, 1, 2, 3];

      console.log('Current grid validator:\n' + 
                    rgg.isValidGrid.toString().replace(/$\s*\/\/.*/gm, '') + '\n');

      var allValidGrids = rgg.generateAllRhytmicGrids(
        width_arr, ratio_arr, baseline_arr, columns_arr, gutter2baselineRatio_arr);

      // required to re-evaluate input arrays, some values (like columns=5, are not valid for any grids)
      baseline_arr = allValidGrids.map(function(g){ return g.baseline }).unique().sort(srt);
      columns_arr  = allValidGrids.map(function(g){ return g.columnsNum }).unique().sort(srt);
      gutter2baselineRatio_arr  = allValidGrids.map(function(g){ return g.gutter.W/g.baseline }).unique().sort(srt);

      $('#placeholder')
        .append( createDropDown('width', width_arr) )
        .append( createDropDown('ratio', ratio_arr) )
        .append( createDropDown('baseline', baseline_arr) )
        .append( createDropDown('columns', columns_arr) )
        .append( createDropDown('gutter', gutter2baselineRatio_arr) )
      
      function createDropDown(id, values){
        var container = $('<div class="ib"></div>');
        var l = $('<label>').css('font-weight', 'bold').text(id);
        var d = $('<form>').prop('id', id);


        container.append(l);
        container.append(d);

        values.map(function(item, i){
          var o = $('<input>').prop({ type: "radio",
                                      name: id+'_radio',
                                      value: item});
          if (!i) o.prop('checked', true);
          
          d.append(o).append( $('<span>').text(item) ); //.append('<br/>');
        });

        // generate grid on each selection change (no need in 'generate' button anymore)
        d.on('change', function(e) {
          var selectedOpts = getSelectedOptionsArr();
          refreshInputSelections(selectedOpts);

          selectedOpts = getSelectedOptionsArr();
          var gridConfig = rgg.selectGrid(allValidGrids, selectedOpts);

          if (gridConfig){
              console.log('Grid object: '); 
              console.log(gridConfig.rhythmicGrid);
              drawGrid(gridConfig);
          }
          else
              $('#grid').empty();
        });

        return container;
      }

      function getSelectedOptionsArr(){
          return [ $('#width > input:checked').val()*1,
                   $('#ratio > input:checked').val(), 
                   $('#baseline > input:checked').val()*1,
                   $('#columns > input:checked').val()*1, 
                   $('#gutter > input:checked').val()*1 
                 ];
      }

      function refreshInputSelections(selectedOpts){
        console.log(selectedOpts);
        var validOptions = rgg.getValidConfigValues(allValidGrids, selectedOpts);
        console.log(validOptions);

        var ids = ['width', 'ratio', 'baseline', 'columns', 'gutter'];
        if (ids.length !== validOptions.length) throw 'IDs arr error in refreshInputSelections()';

        validOptions.forEach( function(v, i) {

            $('#'+ids[i]+' > input').each(function(k, opt){
                $(this).prop('disabled', !v[k][1] || null );
                
                // update gutter value according to baseline value
                if (ids[i] === ids[ids.length-1]){ // if 'gutter'-id
                    $(this).next().text( v[k][0]*selectedOpts[2] );  // gutter*baseline
                }
            });

            // change selected element if current option became disabled
            var selectedOp = $('#'+ids[i]+' > input:checked');
            if ( selectedOp.prop('disabled') ) {
                var enabled = $('#'+ ids[i] +' > input:enabled:last');
                if (enabled.length){
                    enabled.prop('checked', true);
                }
            }

        });

      }

      function drawGrid(gridConfig){
        var grid = gridConfig.rhythmicGrid;
        var columns = gridConfig.columnsNum;
        var gutter  = gridConfig.gutter.W;

        var $base = $('#grid');
        $base.html('');

        $base.css('width', grid.W+'px');
        $base.css('height', grid.H+'px');

        grid.blocks.map(function(block){
          var row = $('<div class="row" style="margin-bottom:'+gutter+'px;"></div>');
          var cnt = columns/block[3];
          var w = block[0];
          var h = block[1];
          var g = gutter;
          for(var i = 0;i<cnt;i++){
            if( i == cnt - 1 ){
              g = 0;
            }
            var block = $('<div class="block" style="width:'+w+'px; height:'+h+'px; margin-right: '+g+'px;"></div>');
            row.append(block);
          }
          $base.append(row);
        });
      }

    // trigger onChange event to initialize selection options and plot grid at startup
    $('#width').trigger('change');

    </script>
  </body>
</html>
